Version 1
SubGoalCombiner SGC_AND
INITSECTION
LLMIME_ItemSystem_InitSettings();
KBSECTION
//REGION SETTINGS
PROC
LLMIME_ItemSystem_InitSettings()
THEN
LeaderLib_Growth_Items_Clear_ByEntriesID("Mimicry.Brawler.Fist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 2, "Boost_LLMIME_BrawlerFist_SkillBoost", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 4, "Boost_Weapon_Damage_ArmourPiercing", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 6, "Boost_LLMIME_BrawlerFist_CritChanceSmall", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 8, "Boost_LLMIME_BrawlerFist_PiercingDamageSmall", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 10, "Boost_LLMIME_BrawlerFist_LifeStealBoost", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 11, "Boost_LLMIME_BrawlerFist_CritDamageSmall", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 12, "Boost_LLMIME_BrawlerFist_WarfareBoost", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 14, "Boost_LLMIME_BrawlerFist_ScoundrelBoost", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 16, "Boost_LLMIME_BrawlerFist_CritDamageLarge", "Tag", "LLMIME_BrawlerFist");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.Brawler.Fist", 18, "Boost_LLMIME_BrawlerFist_DamageBoostMedium", "Tag", "LLMIME_BrawlerFist");

LeaderLib_Growth_Items_Clear_ByEntriesID("Mimicry.MimeEquipment.Mask");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Mask", 2, "Boost_Armor_Helmet_Primary_Memory_PrimaryAsLarge", "Template", "EQ_Armor_LLMIME_Mime_Mask_A_8e66ce79-8c8e-4c22-a8ea-5a99977f4ea8");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Mask", 7, "Boost_Armor_Helmet_Primary_Wits", "Template", "EQ_Armor_LLMIME_Mime_Mask_A_8e66ce79-8c8e-4c22-a8ea-5a99977f4ea8");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Mask", 8, "Boost_Armor_Helmet_Armour_Physical_Large", "Template", "EQ_Armor_LLMIME_Mime_Mask_A_8e66ce79-8c8e-4c22-a8ea-5a99977f4ea8");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Mask", 10, "Boost_Armor_Helmet_Armour_Magical_Large_PlateHelmet", "Template", "EQ_Armor_LLMIME_Mime_Mask_A_8e66ce79-8c8e-4c22-a8ea-5a99977f4ea8");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 11, "Boost_Armor_Helmet_Resistance_Air_Medium", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Mask", 13, "Boost_Armor_Helmet_Resistance_Fire_Medium", "Template", "EQ_Armor_LLMIME_Mime_Mask_A_8e66ce79-8c8e-4c22-a8ea-5a99977f4ea8");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Mask", 16, "Boost_Armor_Helmet_Ability_Warfare", "Template", "EQ_Armor_LLMIME_Mime_Mask_A_8e66ce79-8c8e-4c22-a8ea-5a99977f4ea8");

LeaderLib_Growth_Items_Clear_ByEntriesID("Mimicry.MimeEquipment.Torso");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Torso", 3, "Boost_Armor_Upperbody_Ability_Warfare", "Template", "EQ_Armor_LLMIME_Mime_UpperBody_A_002d96a6-02c1-4e82-9890-67b86ea01531");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Torso", 5, "Boost_Armor_Upperbody_Ability_Death", "Template", "EQ_Armor_LLMIME_Mime_UpperBody_A_002d96a6-02c1-4e82-9890-67b86ea01531");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Torso", 8, "Boost_Armor_Upperbody_Primary_Constitution", "Template", "EQ_Armor_LLMIME_Mime_UpperBody_A_002d96a6-02c1-4e82-9890-67b86ea01531");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Torso", 10, "Boost_Armor_Upperbody_Ability_Hunting", "Template", "EQ_Armor_LLMIME_Mime_UpperBody_A_002d96a6-02c1-4e82-9890-67b86ea01531");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Torso", 11, "Boost_LLMIME_Armor_LowerBody_EmptyRuneSlot", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Torso", 13, "Boost_Armor_Upperbody_Armour_Physical_Large", "Template", "EQ_Armor_LLMIME_Mime_UpperBody_A_002d96a6-02c1-4e82-9890-67b86ea01531");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Torso", 16, "Boost_Armor_Upperbody_Primary_Constitution_Large", "Template", "EQ_Armor_LLMIME_Mime_UpperBody_A_002d96a6-02c1-4e82-9890-67b86ea01531");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Torso", 18, "Boost_Armor_UpperBody_EmptyRuneSlot", "Template", "EQ_Armor_LLMIME_Mime_UpperBody_A_002d96a6-02c1-4e82-9890-67b86ea01531");

LeaderLib_Growth_Items_Clear_ByEntriesID("Mimicry.MimeEquipment.Pants");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 2, "Boost_Armor_Pants_Primary_Constitution_PrimaryAsLarge", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 4, "Boost_Armor_Pants_Secondary_MovementSpeed", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 7, "Boost_Armor_Pants_Ability_Perseverance", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 10, "Boost_Armor_Pants_Ability_Warfare_Large", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 12, "Boost_LLMIME_Armor_LowerBody_EmptyRuneSlot", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 14, "Boost_Armor_Pants_Armour_Magical_MagePants", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 17, "Boost_Armor_Pants_Immunity_Frozen_And_Chilled", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Pants", 18, "Boost_LLMIME_Armor_LowerBody_EmptyRuneSlot", "Template", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");

LeaderLib_Growth_Items_Clear_ByEntriesID("Mimicry.MimeEquipment.Gloves");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Gloves", 4, "Boost_Armor_Gloves_Secondary_CriticalChance_Large", "Template", "EQ_Armor_LLMIME_Mime_Arms_A_719c05ec-03d1-4910-b709-1ced217cd136");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Gloves", 8, "Boost_LLMIME_BrawlerFist_SkillBoost_Gloves_Large", "Template", "EQ_Armor_LLMIME_Mime_Arms_A_719c05ec-03d1-4910-b709-1ced217cd136");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Gloves", 10, "Boost_LLMIME_Armor_Gloves_EmptyRuneSlot", "Template", "EQ_Armor_LLMIME_Mime_Arms_A_719c05ec-03d1-4910-b709-1ced217cd136");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Gloves", 13, "Boost_Armor_Gloves_Crafting_Special_Ataraxian", "Template", "EQ_Armor_LLMIME_Mime_Arms_A_719c05ec-03d1-4910-b709-1ced217cd136");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Gloves", 15, "Boost_LLMIME_Armor_Gloves_EmptyRuneSlot", "Template", "EQ_Armor_LLMIME_Mime_Arms_A_719c05ec-03d1-4910-b709-1ced217cd136");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Gloves", 19, "Boost_Armor_Gloves_Immunity_Slow_And_Sleeping", "Template", "EQ_Armor_LLMIME_Mime_Arms_A_719c05ec-03d1-4910-b709-1ced217cd136");

LeaderLib_Growth_Items_Clear_ByEntriesID("Mimicry.MimeEquipment.Boots");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Boots", 3, "Boost_LLMIME_Armor_Boots_JumpSkill", "Template", "EQ_Armor_LLMIME_Mime_Legs_A_5b2a8469-a1a2-41cf-a861-8b997330f522");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Boots", 6, "Boost_Armor_Boots_Secondary_Dodge_Large", "Template", "EQ_Armor_LLMIME_Mime_Legs_A_5b2a8469-a1a2-41cf-a861-8b997330f522");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Boots", 9, "Boost_LLMIME_Skill_EvasiveManeuver_Mime", "Template", "EQ_Armor_LLMIME_Mime_Legs_A_5b2a8469-a1a2-41cf-a861-8b997330f522");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Boots", 11, "Boost_LLMIME_Armor_Boots_EmptyRuneSlot", "Template", "EQ_Armor_LLMIME_Mime_Legs_A_5b2a8469-a1a2-41cf-a861-8b997330f522");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Boots", 13, "Boost_Armor_Boots_Secondary_MovementSpeed_Large", "Template", "EQ_Armor_LLMIME_Mime_Legs_A_5b2a8469-a1a2-41cf-a861-8b997330f522");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Boots", 15, "Boost_Armor_Boots_Crafting_Special_Ataraxian", "Template", "EQ_Armor_LLMIME_Mime_Legs_A_5b2a8469-a1a2-41cf-a861-8b997330f522");
LeaderLib_Growth_Items_Register_DeltaMod("Mimicry.MimeEquipment.Boots", 17, "Boost_LLMIME_Armor_Boots_EmptyRuneSlot", "Template", "EQ_Armor_LLMIME_Mime_Legs_A_5b2a8469-a1a2-41cf-a861-8b997330f522");

PROC
LLMIME_ItemSystem_InitSettings()
AND
NOT DB_LLMIME_ItemSystem_MimeEquipment(_,_)
THEN
DB_LLMIME_ItemSystem_MimeEquipment("Breast", "EQ_Armor_LLMIME_Mime_UpperBody_A_002d96a6-02c1-4e82-9890-67b86ea01531");
DB_LLMIME_ItemSystem_MimeEquipment("Gloves", "EQ_Armor_LLMIME_Mime_Arms_A_719c05ec-03d1-4910-b709-1ced217cd136");
DB_LLMIME_ItemSystem_MimeEquipment("Leggings", "EQ_Armor_LLMIME_Mime_LowerBody_A_134cbd6d-c5f5-4e7c-a7ff-a0f17644baab");
DB_LLMIME_ItemSystem_MimeEquipment("Boots", "EQ_Armor_LLMIME_Mime_Legs_A_5b2a8469-a1a2-41cf-a861-8b997330f522");
//END_REGION

//REGION UPDATING
QRY
LLMIME_ItemSystem_Internal_QRY_VersionNeedsUpdating("0.9.7.0")
THEN
DB_NOOP(1);

/*
QRY
LLMIME_ItemSystem_Internal_QRY_VersionNeedsUpdating((STRING)_Version)
AND
LeaderLib_StringExt_QRY_VersionIsLessThan(_Version, 1, 0, 2, 0)
THEN
TimerLaunch("LLMIME_Timers_UpdateMimeEquipmentGrowth", 1000);
*/
PROC
LeaderUpdater_ModUpdated("Mimicry", "LaughingLeader", (STRING)_PastVersion, (STRING)_NewVersion)
AND
LLMIME_ItemSystem_Internal_QRY_VersionNeedsUpdating(_PastVersion)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:ItemSystem] Updating settings from version [",_PastVersion,"]");
LLMIME_ItemSystem_InitSettings();
LLMIME_ItemSystem_ResetMimeEquipment();

IF
TimerFinished("LLMIME_Timers_UpdateMimeEquipmentGrowth")
AND
DB_IsPlayer(_Player)
THEN
LeaderLib_Growth_Items_CheckEquipmentForMissingDeltamods(_Player);

PROC
LLMIME_ItemSystem_ResetMimeEquipment()
AND
DB_IsPlayer(_Player)
AND
GetPosition(_Player, _x, _y, _z)
AND
DB_LLMIME_ItemSystem_MimeEquipment(_Slot, _Template)
AND
CharacterGetEquippedItem(_Player, _Slot, (ITEMGUID)_Item)
AND
GetTemplate(_Item, _Template)
AND
CreateItemTemplateAtPosition(_Template, _x, _y, _z, _NewItem)
THEN
ItemRemove(_Item);
CharacterEquipItem(_Player, _NewItem);
//END_REGION

//REGION FIST_EQUIPPING
PROC
ProcBlockUseOfItem(_Character, _Item)
AND
IsTagged(_Item, "LLMIME_BrawlerFist", 1)
AND
NOT LLMIME_QRY_CharacterIsAMime(_Character)
THEN
CharacterStatusText(_Character, "LLMIME_StatusText_BrawlerFistBlocked");
DB_CustomUseItemResponse(_Character, _Item, 0);
//DB_LLMIME_Items_Temp_BlockedItem(_Character, _Item);
//END_REGION

//REGION MASK_EQUIPPING
PROC
ProcBlockUseOfItem(_Character, _Item)
AND
LLMIME_Mime_QRY_IsMimeItem(_Item)
AND
GetTemplate(_Item, _Template)
AND
DB_LLMIME_Templates("Mask_A", _Template)
AND
NOT CharacterGetEquippedItem(_Character, "Helmet", _Item) // Mask not equipped
AND
CharacterIsInCombat(_Character, 1)
THEN
CharacterStatusText(_Character, "LLMIME_StatusText_MimeMaskBlocked");
DB_CustomUseItemResponse(_Character, _Item, 0);
//DB_LLMIME_Items_Temp_BlockedItem(_Character, _Item);
//END_REGION

//REGION MIME_SKILLBOOKS
PROC
ProcBlockUseOfItem(_Character, _Item)
AND
IsTagged(_Item, "LLMIME_MimeSkillbook", 1)
AND
NOT LLMIME_QRY_CharacterIsAMime(_Character)
THEN
CharacterStatusText(_Character, "LLMIME_StatusText_MimeSkillbookBlocked");
DB_CustomUseItemResponse(_Character, _Item, 0);
//END_REGION

//REGION MIME_FOLLOWER
PROC
ProcBlockUseOfItem(_Mime, _Item)
AND
IsTagged(_Item, "BOOK", 1)
AND
IsTagged(_Mime, "LLMIME_MimeFollower", 1)
THEN
CharacterStatusText(_Mime, "LLMIME_StatusText_SkillbookBlockedForFollower");
DB_CustomUseItemResponse(_Mime, _Item, 0);

//Prevent general item useage with the Mime follower
PROC
ProcBlockUseOfItem(_Mime, _Item)
AND
IsTagged(_Mime, "LLMIME_MimeFollower", 1)
AND
NOT DB_CustomUseItemResponse(_Mime, _Item, _)
AND
NOT LLMIME_Mimicking_QRY_IsMimicking(_Mime)
AND
ItemIsInInventory(_Item, 1)
AND
NOT LLMIME_Mimicking_QRY_IsMimicking(_Mime)
AND
NOT GetInventoryOwner(_Item, _Mime)
THEN
DB_CustomUseItemResponse(_Mime, _Item, 0);
//END_REGION

//REGION MUSIC_BOX_USAGE
PROC
ProcBlockUseOfItem(_Char, _Item)
AND
IsTagged(_Item, "LLMIME_MimeSummonTool", 1)
AND
NOT GlobalGetFlag("Mimicry_MusicBoxShattered", 1)
THEN
LLMIME_Items_OnMusicBoxUsed(_Char, _Item);

//Why do they still have this?
PROC
ProcBlockUseOfItem(_Char, _Item)
AND
IsTagged(_Item, "LLMIME_MimeSummonTool", 1)
AND
GlobalGetFlag("Mimicry_MusicBoxShattered", 1)
THEN
CharacterStatusText(_Char, "LLMIME_StatusText_MusicBoxBlocked");
DB_CustomUseItemResponse(_Char, _Item, 0);

//Resurrection dialog (mask required)
PROC
LLMIME_Items_OnMusicBoxUsed((CHARACTERGUID)_Char, (ITEMGUID)_Item)
AND
NOT DB_CustomUseItemResponse(_Char, _Item, _)
AND
CharacterIsInCombat(_Char, 0)
AND
NOT LLMIME_Follower_QRY_CanSummon(_Char)
AND
LLMIME_Follower_QRY_CanResurrectMime(_Char)
THEN
DB_CustomUseItemResponse(_Char, _Item, 0);
//LLMIME_Follower_Internal_SetupMusicBoxAttributeCheck(_Char);
Proc_StartDialog(0, "LLMIME_MusicBox_Resurrection", _Item, _Char);

PROC
LLMIME_Items_OnMusicBoxUsed((CHARACTERGUID)_Char, (ITEMGUID)_Item)
AND
NOT DB_CustomUseItemResponse(_Char, _Item, _)
AND
CharacterIsInCombat(_Char, 0)
AND
NOT LLMIME_Follower_QRY_CanSummon(_Char)
AND
NOT LLMIME_Follower_QRY_CanResurrectMime(_Char)
THEN
CharacterStatusText(_Char, "LLMIME_StatusText_MusicBoxBlocked");
DB_CustomUseItemResponse(_Char, _Item, 0);

PROC
LLMIME_Items_OnMusicBoxUsed((CHARACTERGUID)_Char, (ITEMGUID)_Item)
AND
NOT DB_CustomUseItemResponse(_Char, _Item, _)
AND
LLMIME_Follower_QRY_CanSummon(_Char)
THEN
CharacterStatusText(_Char, "LLMIME_StatusText_MusicBoxUsed");
DB_CustomUseItemResponse(_Char, _Item, 1);

PROC
LLMIME_Items_OnMusicBoxUsed((CHARACTERGUID)_Char, (ITEMGUID)_Item)
AND
NOT DB_CustomUseItemResponse(_Char, _Item, _)
THEN
CharacterStatusText(_Char, "LLMIME_StatusText_MusicBoxBlocked");
DB_CustomUseItemResponse(_Char, _Item, 0);

IF
DB_CustomUseItemResponse(_Char, _Item, 0)
AND
IsTagged(_Item, "LLMIME_MimeSummonTool", 1)
AND
DB_LLMIME_Follower_Mime(_Mime)
AND
CharacterIsDead(_Mime, 0)
AND
IsTagged(_Mime, "LeaderLib_IsFollower", 1)
THEN
LLMIME_Follower_ReturnIfNotInCombat(_Char, _Mime);

PROC
ProcBlockUseOfItem((CHARACTERGUID)_Char, (ITEMGUID)_Item)
AND
IsTagged(_Item, "LLMIME_MusicBoxShard", 1)
AND
DB_LLMIME_Follower_Mime(_Mime)
AND
NOT IsTagged(_Mime, "LeaderLib_IsFollower", 1)
THEN
DB_CustomUseItemResponse(_Char, _Item, 0);
CharacterStatusText(_Char, "LLMIME_StatusText_MusicBoxShardBlocked");

IF
CharacterUsedItemTemplate(_Char, _Template, _Item)
AND
DB_LLMIME_Templates("MusicBox_Shard", _Template)
AND
DB_LLMIME_Follower_Mime(_Mime)
AND
CharacterIsDead(_Mime, 0)
AND
IsTagged(_Mime, "LeaderLib_IsFollower", 1)
THEN
LLMIME_Follower_ReturnIfNotInCombat(_Char, _Mime);
//END_REGION

//REGION MUSIC_BOX_TRANSFORM
PROC
LLMIME_Items_TransformMusicBox((CHARACTERGUID)_Player, (ITEMGUID)_MusicBox)
AND
NOT DB_LLMIME_Items_Temp_MusicBoxTransformed(_Player, _MusicBox)
AND
DB_LLMIME_Templates("MusicBox", _Template)
AND
GetTemplate(_MusicBox, _Template)
AND
DB_LLMIME_Templates("MusicBox_Cracked", _TransformTemplate)
THEN
Transform(_MusicBox, _TransformTemplate, 1, 0, 1);
SetTag(_MusicBox, "Mimicry_CrackedMusicBox");
DB_LLMIME_Items_Temp_MusicBoxTransformed(_Player, _MusicBox);

PROC
LLMIME_Items_TransformMusicBox((CHARACTERGUID)_Player, (ITEMGUID)_MusicBox)
AND
NOT DB_LLMIME_Items_Temp_MusicBoxTransformed(_Player, _MusicBox)
AND
DB_LLMIME_Templates("MusicBox_Cracked", _Template)
AND
GetTemplate(_MusicBox, _Template)
AND
DB_LLMIME_Templates("MusicBox_Shard", _TransformTemplate)
THEN
ClearTag(_MusicBox, "Mimicry_CrackedMusicBox");
Transform(_MusicBox, _TransformTemplate, 1, 1, 1);
CharacterStatusText(_Player, "LLMIME_StatusText_MusicBoxShatters");
LeaderLog_SetOneshotTarget(_Player);
LeaderLog_Log("COMBAT", "LLMIME_StatusText_MusicBoxShatters");
GlobalSetFlag("Mimicry_MusicBoxShattered");
DB_LLMIME_Items_Temp_MusicBoxTransformed(_Player, _MusicBox);

PROC
LLMIME_Items_TransformMusicBox((CHARACTERGUID)_Player, (ITEMGUID)_MusicBox)
AND
DB_LLMIME_Items_Temp_MusicBoxTransformed(_Player, _MusicBox)
THEN
NOT DB_LLMIME_Items_Temp_MusicBoxTransformed(_Player, _MusicBox);
//END_REGION

//REGION MUSICBOX_RESURRECTION_DIALOG_ATT_CHECK
IF
DialogStarted("LLMIME_MusicBox_Resurrection", _Instance)
AND
DialogGetInvolvedPlayer(_Instance, 1, (CHARACTERGUID)_Player)
AND
CharacterGetAttribute(_Player, "Intelligence", _Amount)
AND
_Amount >= 15
THEN
LeaderLog_Log("DEBUG", "[LLMIME:ItemSystem:SetupMusicBoxAttributeCheck] Player's intelligence passes the requirement.");
ObjectSetDialogFlag(_Player, "Mimicry_CanReadMusicBoxGlyphs", _Instance);

/*
PROC
LLMIME_Follower_Internal_SetupMusicBoxAttributeCheck((CHARACTERGUID)_Player)
AND
CharacterGetLevel(_Player, _Level)
AND
_Level > 2
AND
IntegerSubtract(_Level, 1, _CheckLevel)
THEN
//This DB is automatically cleared when adding a new entry
LeaderLog_Log("DEBUG", "[LLMIME:ItemSystem:SetupMusicBoxAttributeCheck] Player's level is greater than 2.");
DB_GLO_Attribute_Check_AgainstLevel("LLMIME_MusicBox_Resurrection", 1, "Intelligence", "Normal", 1, _CheckLevel);

PROC
LLMIME_Follower_Internal_SetupMusicBoxAttributeCheck((CHARACTERGUID)_Player)
AND
CharacterGetLevel(_Player, _Level)
AND
_Level <= 2
THEN
LeaderLog_Log("DEBUG", "[LLMIME:ItemSystem:SetupMusicBoxAttributeCheck] Player's level is less than or equal to 2.");
DB_GLO_Attribute_Check_AgainstLevel("LLMIME_MusicBox_Resurrection", 1, "Intelligence", "Easy", 1, 1);
*/
//END_REGION

//REGION EQUIP_BLOCKING
IF
ItemEquipped(_Item, _Character)
AND
DB_LLMIME_Items_Temp_BlockedItem(_Character, _Item)
THEN
NOT DB_LLMIME_Items_Temp_BlockedItem(_Character, _Item);
CharacterUnequipItem(_Character, _Item);
//END_REGION

//REGION DEBUG
/*
IF
ItemEquipped(_Item, _Character)
AND
GetTemplate(_Item, _Template)
AND
CharacterGetDisplayName(_Character, _, _Name)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:ItemEquipped] [",_Name,"] equipped item [",_Template,"].");

IF
ItemUnEquipped(_Item, _Character)
AND
GetTemplate(_Item, _Template)
AND
CharacterGetDisplayName(_Character, _, _Name)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:ItemUnEquipped] [",_Name,"] unequipped item [",_Template,"].");

IF
CanUseItem(_Mime, _Item, _RequestID)
AND
GetTemplate(_Item, _Template)
AND
CharacterGetDisplayName(_Mime, _, _Name)
AND
IntegertoString(_RequestID, _RequestIDStr)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:CanUseItem] [",_Name,"] is attempting to use item [",_Template,"] with RequestID [",_RequestIDStr,"].");

IF
CharacterUsedItem(_Mime, _Item)
AND
GetTemplate(_Item, _Template)
AND
CharacterGetDisplayName(_Mime, _, _Name)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:CharacterUsedItem] [",_Name,"] used item [",_Template,"].");

IF
CharacterUsedItemTemplate(_Mime, _Template, _Item)
AND
CharacterGetDisplayName(_Mime, _, _Name)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:CharacterUsedItemTemplate] [",_Name,"] used item [",_Template,"].");

IF
CharacterUsedItemFailed(_Mime, _Item)
AND
GetTemplate(_Item, _Template)
AND
CharacterGetDisplayName(_Mime, _, _Name)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:CharacterUsedItemFailed] [",_Name,"] failed to use item [",_Template,"].");

IF
ItemDestroying(_Item)
AND
GetTemplate(_Item, _Template)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:ItemDestroying] Item [",_Template,"] is being destroyed.");

IF
ItemDestroyed(_Item)
AND
GetTemplate(_Item, _Template)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:ItemDestroying] Item [",_Template,"] was destroyed.");

IF
CharacterItemEvent(_Mime, _Item, "LLMIME_Events_OnItemUse")
AND
GetTemplate(_Item, _Template)
AND
CharacterGetDisplayName(_Mime, _, _Name)
THEN
LeaderLog_Log("DEBUG", "[LLMIME:Debug:LLMIME_Events_OnItemUse] [",_Name,"] used item [",_Template,"].");
*/
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LaughingLeader_Mimicry"
