Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION

//REGION MIMICKING_STATUS
IF
ObjectWasTagged((CHARACTERGUID)_Mime, "Mimicry_Mime")
THEN
LLMIME_Mimicking_ApplyMimicking(_Mime);

IF
CharacterStatusApplied(_Mime, "LLMIME_MIME", _)
THEN
LLMIME_Mimicking_ApplyMimicking(_Mime);

IF
CharacterStatusRemoved(_Mime, "LLMIME_MIMICKING_DISABLED", _)
THEN
LLMIME_Mimicking_ApplyMimicking(_Mime);

IF
ObjectTurnEnded((CHARACTERGUID)_Mime)
AND
IsTagged(_Mime, "Mimicry_Mime", 1)
AND
CharacterIsInCombat(_Mime, 1)
THEN
LeaderLib_StartObjectTimer(_Mime, 500, "LLMIME_Timers_AfterTurn_ApplyMimicking_", "LLMIME_Events_RequestMimicking");

IF
ObjectEnteredCombat((CHARACTERGUID)_Mime, _CombatID)
THEN
LLMIME_Mimicking_ApplyMimicking(_Mime);

IF
StoryEvent((CHARACTERGUID)_Mime, "LLMIME_Events_RequestMimicking")
THEN
LLMIME_Mimicking_ApplyMimicking(_Mime);

PROC
LLMIME_Mimicking_ApplyMimicking((CHARACTERGUID)_Mime)
AND
IsTagged(_Mime, "LLMIME_MimeFollower", 0)
AND
IsTagged(_Mime, "Mimicry_EnemyMime", 0)
AND
LLMIME_Mimicking_QRY_MimeShouldBeMimicking(_Mime)
AND
NOT LeaderLib_Helper_QRY_HasStatus(_Mime, "LLMIME_MIMICKING")
THEN
ApplyStatus(_Mime, "LLMIME_MIMICKING", -1.0, 1);

PROC
LLMIME_Mimicking_ApplyMimicking((CHARACTERGUID)_Mime)
AND
IsTagged(_Mime, "LLMIME_MimeFollower", 1)
AND
NOT LeaderLib_Helper_QRY_HasStatus(_Mime, "LLMIME_MIMICKING_FOLLOWER")
AND
LLMIME_Mimicking_QRY_FollowerShouldBeMimicking(_Mime)
THEN
ApplyStatus(_Mime, "LLMIME_MIMICKING_FOLLOWER", -1.0, 1);

PROC
LLMIME_Mimicking_ApplyMimicking((CHARACTERGUID)_Mime)
AND
IsTagged(_Mime, "Mimicry_EnemyMime", 1)
AND
NOT LeaderLib_Helper_QRY_HasStatus(_Mime, "LLMIME_MIMICKING_ENEMY")
AND
LLMIME_Mimicking_QRY_MimeShouldBeMimicking(_Mime)
THEN
ApplyStatus(_Mime, "LLMIME_MIMICKING_ENEMY", -1.0, 1);

IF
CharacterStatusApplied(_Mime, _Status, _)
AND
DB_LLMIME_MimickingStatuses(_Status)
THEN
ObjectClearFlag(_Mime, "Mimicry_MimickingWasRemoved");

IF
StoryEvent((CHARACTERGUID)_Mime, "LLMIME_Events_RemoveMimicking")
THEN
LLMIME_Mimicking_RemoveMimicking(_Mime);

IF
ObjectTurnStarted((CHARACTERGUID)_Mime)
AND
LLMIME_QRY_CharacterIsAMime(_Mime)
THEN
LLMIME_Mimicking_RemoveMimicking(_Mime);

IF
ObjectLeftCombat((CHARACTERGUID)_Mime, _CombatID)
AND
NOT GlobalGetFlag("Mimicry_Mimic_CombatOnlyDisabled", 1)
THEN
LLMIME_Mimicking_RemoveMimicking(_Mime);

IF
CharacterStatusApplied(_Mime, "LLMIME_MIMICKING_DISABLED", _)
THEN
LLMIME_Mimicking_RemoveMimicking(_Mime);

PROC
LLMIME_Mimicking_RemoveMimicking((CHARACTERGUID)_Mime)
AND
DB_LLMIME_MimickingStatuses(_Status)
AND
HasActiveStatus(_Mime, _Status, 1)
THEN
ObjectSetFlag(_Mime, "Mimicry_MimickingWasRemoved");
RemoveStatus(_Mime, _Status);

/*
PROC
LLMIME_Mimicking_RemoveMimicking((CHARACTERGUID)_Mime)
AND
ObjectGetFlag(_Mime, "Mimicry_MimickingWasRemoved", 1)
AND
DB_LeaderLib_Combat_ActiveObject(_, _Mime)
THEN
CharacterStatusText(_Mime, "LLMIME_StatusText_MimickingEnded");
*/

PROC
LLMIME_Mimicking_RemoveMimicking((CHARACTERGUID)_Mime)
AND
ObjectGetFlag(_Mime, "Mimicry_MimickingWasRemoved", 1)
THEN
ObjectClearFlag(_Mime, "Mimicry_MimickingWasRemoved");

IF
CharacterStatusRemoved(_Mime, _Status, _)
AND
DB_LLMIME_MimickingStatuses(_Status)
AND
DB_LLMIME_Mimicking_MimicNextAction(_Mime)
THEN
NOT DB_LLMIME_Mimicking_MimicNextAction(_Mime);
LLMIME_Mimicking_OnMimickingDisabled(_Mime);

IF
CharacterStatusApplied(_Mime, _Status, _)
AND
DB_LLMIME_MimickingStatuses(_Status)
AND
NOT DB_LLMIME_Mimicking_MimicNextAction(_Mime)
AND
NOT DB_LeaderLib_Combat_ActiveObject(_, (GUIDSTRING)_Mime)
THEN
DB_LLMIME_Mimicking_MimicNextAction((CHARACTERGUID)_Mime);

IF
DB_LLMIME_Mimicking_MimicNextAction(_Mime)
THEN
LLMIME_Mimicking_OnMimickingEnabled(_Mime);

PROC
LLMIME_Mimicking_OnMimickingEnabled((CHARACTERGUID)_Mime)
THEN
DB_NOOP(1);

PROC
LLMIME_Mimicking_OnMimickingDisabled((CHARACTERGUID)_Mime)
THEN
DB_NOOP(1);
//END_REGION


/*
Some of the mimicking events can be quite broad, so this script is used to disable them when nobody is mimicking.
*/

//REGION SCRIPT_TOGGLING
PROC
LLMIME_Mimicking_OnMimickingEnabled((CHARACTERGUID)_Mime)
AND
NOT DB_LLMIME_Mimicking_ScriptsEnabled(1)
THEN
DB_LLMIME_Mimicking_ScriptsEnabled(1);
SysActivateGoal("LLMIME_01_Mimicking_04_Main");
SysActivateGoal("LLMIME_01_Mimicking_05_Skills");
SysActivateGoal("LLMIME_01_Mimicking_06_Attacking");
SysActivateGoal("LLMIME_01_Mimicking_07_Items");

PROC
LLMIME_Mimicking_OnMimickingDisabled((CHARACTERGUID)_Mime)
AND
SysCount("DB_LLMIME_Mimicking_MimicNextAction", 1, 0)
THEN
LLMIME_Mimicking_OnScriptsCompleting();
SysCompleteGoal("LLMIME_01_Mimicking_04_Main");
SysCompleteGoal("LLMIME_01_Mimicking_05_Skills");
SysCompleteGoal("LLMIME_01_Mimicking_06_Attacking");
SysCompleteGoal("LLMIME_01_Mimicking_07_Items");
//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LaughingLeader_Mimicry"