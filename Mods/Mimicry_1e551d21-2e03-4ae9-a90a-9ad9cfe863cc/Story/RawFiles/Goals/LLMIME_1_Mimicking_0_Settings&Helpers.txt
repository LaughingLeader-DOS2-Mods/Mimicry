Version 1
SubGoalCombiner SGC_AND
INITSECTION
LLMIME_Mimicking_InitSettings();

//DB_LLMIME_Mimicking_Blacklist_SkillTypes(_SkillType, _GlobalFlag, _EnabledState)
//DB_LLMIME_Mimicking_Blacklist_Skills(_Skill)
//DB_LLMIME_Mimicking_Blacklist_SkillElements(_SkillType, _SkillElement)
//DB_LLMIME_Mimicking_Blacklist_SkillPrefixes(_Prefix)
KBSECTION
//REGION SETTINGS
PROC
LLMIME_Mimicking_InitSettings()
THEN
DB_LLMIME_Mimicking_Blacklist_SkillTypes("Path", "Mimicry_Mimic_SkillType_Path_Enabled", 1);
DB_LLMIME_Mimicking_Blacklist_SkillTypes("Summon", "Mimicry_Mimic_SkillType_Summons_Enabled", 1);
DB_LLMIME_Mimicking_Blacklist_SkillElements("Shout", ""); // Special type shout skills, typically used for toggle abilities in mods
DB_LLMIME_Mimicking_Blacklist_Skills("Shout_FavourableWind");
DB_LLMIME_Mimicking_Blacklist_SkillPrefixes("_CA_");

DB_LLMIME_Mimicking_Whitelist_ItemTags("Potion");
DB_LLMIME_Mimicking_Whitelist_ItemTags("POTIONS");
DB_LLMIME_Mimicking_Whitelist_ItemTags("DRINK");
DB_LLMIME_Mimicking_Whitelist_ItemTags("FOOD");

//DB_LLMIME_Mimicking_Blacklist_ItemTags("");
DB_LLMIME_Mimicking_Blacklist_ItemTemplates("CON_Potion_BloodRose_8c89072f-820b-46cb-83af-757b3d469c93");
DB_LLMIME_Mimicking_Blacklist_ItemTemplates("CON_Potion_Source_A_23cdecb1-06a4-4290-bb2c-de300cba5dd0");
DB_LLMIME_Mimicking_Blacklist_ItemTemplates("LOOT_Source_Orb_106a7107-cf36-4331-b5b5-6de71969f370");

//Skill types with the "UseWeaponDamage" property
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("Target");
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("Shout");
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("Projectile");
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("ProjectileStrike");
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("Cone");
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("Zone");
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("MultiStrike");
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("Rush");
DB_LLMIME_Mimicking_Whitelist_WeaponCopy_SkillTypes("Rain");

DB_LLMIME_Mimicking_Blacklist_WeaponCopy_IgnoreSkillsWith("_Grenade_");
//END_REGION

//REGION BLACKLIST_CHECK_ITEMS
QRY
LLMIME_Mimicking_QRY_ItemIsAllowed((ITEMGUID)_Item)
AND
GetTemplate(_Item, _Template)
AND
NOT DB_LLMIME_Mimicking_Blacklist_ItemTemplates(_Template)
AND
DB_LLMIME_Mimicking_Whitelist_ItemTags(_Tag)
AND
IsTagged(_Item, _Tag, 1)
THEN
DB_NOOP(1);
//END_REGION

//REGION BLACKLIST_CHECK_SKILLS
QRY
LLMIME_Mimicking_QRY_SkillIsAllowed((STRING)_Skill)
AND
NOT DB_LLMIME_Mimicking_Blacklist_Skills(_Skill)
AND
NOT DB_LLMIME_SkillData(_Skill, _, _)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_SkillIsAllowed((STRING)_Skill)
AND
NOT DB_LLMIME_Mimicking_Blacklist_Skills(_Skill)
AND
DB_LLMIME_SkillData(_Skill, _SkillType, _SkillElement)
AND
LLMIME_Mimicking_QRY_Internal_BlockedSkillTypeIsEnabled(_SkillType)
AND
NOT DB_LLMIME_Mimicking_Blacklist_SkillElements(_SkillType, _SkillElement)
AND
NOT LLMIME_Mimicking_QRY_Internal_SkillNameMatchesBlocked(_Skill)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_Internal_BlockedSkillTypeIsEnabled((STRING)_SkillType)
AND
DB_LLMIME_Mimicking_Blacklist_SkillTypes(_SkillType, _GlobalFlag, _EnabledState)
AND
GlobalGetFlag(_GlobalFlag, _EnabledState)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_Internal_BlockedSkillTypeIsEnabled((STRING)_SkillType)
AND
NOT DB_LLMIME_Mimicking_Blacklist_SkillTypes(_SkillType, _, _)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_Internal_SkillNameMatchesBlocked((STRING)_Skill)
AND
DB_LLMIME_Mimicking_Blacklist_SkillPrefixes(_Prefix)
AND
StringContains(_Skill, _Prefix, 1)
THEN
DB_NOOP(1);
//END_REGION

//REGION CHECK_QUERIES
QRY
LLMIME_Mimicking_QRY_CanMimicCharacter((CHARACTERGUID)_Character, (CHARACTERGUID)_Mime)
AND
NOT LLMIME_QRY_MimeIsCurrentlyMimicking(_Mime)
AND
_Character != _Mime
AND
NOT LLMIME_QRY_CharacterIsAMime(_Character) // Endless loops are bad!
AND
LLMIME_Mimicking_QRY_CombatConditionsMet(_Character, _Mime)
AND
LLMIME_Mimicking_QRY_PartyConditionsMet(_Character, _Mime)
AND
LLMIME_Mimicking_QRY_CanMimicSummon(_Character)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CombatConditionsMet((CHARACTERGUID)_Character, (CHARACTERGUID)_Mime)
AND
GlobalGetFlag("Mimicry_Mimic_CombatOnlyDisabled", 1)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CombatConditionsMet((CHARACTERGUID)_Character, (CHARACTERGUID)_Mime)
AND
NOT GlobalGetFlag("Mimicry_Mimic_CombatOnlyDisabled", 1)
AND
DB_LeaderLib_Combat_Objects(_CombatID, _Character)
AND
DB_LeaderLib_Combat_Objects(_CombatID, _Mime) // Same combat as the target to copy
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_PartyConditionsMet((CHARACTERGUID)_Character, (CHARACTERGUID)_Mime)
AND
GlobalGetFlag("Mimicry_Mimic_PartyOnlyDisabled", 1)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_PartyConditionsMet((CHARACTERGUID)_Character, (CHARACTERGUID)_Mime)
AND
NOT GlobalGetFlag("Mimicry_Mimic_PartyOnlyDisabled", 1)
AND
CharacterIsInPartyWith(_Character, _Mime, 1)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CanMimicSummon((CHARACTERGUID)_Character)
AND
CharacterIsSummon(_Character, 0)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CanMimicSummon((CHARACTERGUID)_Character)
AND
CharacterIsSummon(_Character, 1)
AND
GlobalGetFlag("Mimicry_Mimic_CopySummonedCreatureSkills_Enabled", 1)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CanMimicSourceSkill((STRING)_Skill)
AND
IsSourceSkill(_Skill, 0)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CanMimicSourceSkill((STRING)_Skill)
AND
IsSourceSkill(_Skill, 1)
AND
GlobalGetFlag("Mimicry_Mimic_CopySourceSkills_Enabled", 1)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CanMimicSkill((STRING)_Skill)
AND
LLMIME_Mimicking_QRY_CanMimicSourceSkill(_Skill)
AND
LLMIME_Mimicking_QRY_SkillIsAllowed(_Skill)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CharacterIsMimickable((CHARACTERGUID)_Character)
AND
CharacterIsPlayer(_Character, 1)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CharacterIsMimickable((CHARACTERGUID)_Character)
AND
CharacterIsPlayer(_Character, 0)
AND
CharacterIsSummon(_Character, 1)
AND
GlobalGetFlag("Mimicry_Mimic_CopySummonedCreatureSkills_Enabled", 1)
AND
CharacterGetOwner(_Character, _Owner)
AND
CharacterIsPlayer(_Owner, 1)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_MimesAvailable()
AND
DB_LLMIME_Mimicking_MimicNextAction(_Mime)
AND
NOT LLMIME_QRY_MimeIsCurrentlyMimicking(_Mime)
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CasterAndTargetMatch((CHARACTERGUID)_Character, (GUIDSTRING)_Target, (STRING)_SkillType)
AND
_SkillType == "Shout"
THEN
DB_NOOP(1);

QRY
LLMIME_Mimicking_QRY_CasterAndTargetMatch((CHARACTERGUID)_Character, (GUIDSTRING)_Target, (STRING)_SkillType)
AND
(GUIDSTRING)_Character == _Target
THEN
DB_NOOP(1);
//END_REGION

//REGION MIMICKING_STATUS
IF
CharacterStatusApplied(_Mime, "LLMIME_MIME", _)
AND
HasActiveStatus(_Mime, "LLMIME_MIMICKING", 1)
AND
NOT LLMIME_QRY_MimeShouldBeMimicking(_Mime)
THEN
RemoveStatus(_Mime, "LLMIME_MIMICKING");

IF
CharacterStatusApplied(_Mime, "LLMIME_MIME", _)
AND
HasActiveStatus(_Mime, "LLMIME_MIMICKING", 0)
AND
LLMIME_QRY_MimeShouldBeMimicking(_Mime)
THEN
ApplyStatus(_Mime, "LLMIME_MIMICKING", -1.0);

/* Handled in behavior script, since it can iterate by tag
IF
GlobalFlagSet("Mimicry_Mimic_CombatOnlyDisabled")
AND
DB_IsPlayer(_Mime)
AND
HasActiveStatus(_Mime, "LLMIME_MIME", 1)
AND
HasActiveStatus(_Mime, "LLMIME_MIMICKING", 0)
AND
LLMIME_QRY_MimeShouldBeMimicking(_Mime)
THEN
ApplyStatus(_Mime, "LLMIME_MIMICKING", -1.0);

IF
GlobalFlagCleared("Mimicry_Mimic_CombatOnlyDisabled")
AND
DB_IsPlayer(_Mime)
AND
HasActiveStatus(_Mime, "LLMIME_MIME", 1)
AND
HasActiveStatus(_Mime, "LLMIME_MIMICKING", 1)
AND
NOT LLMIME_QRY_MimeShouldBeMimicking(_Mime)
THEN
RemoveStatus(_Mime, "LLMIME_MIMICKING");
*/

IF
ObjectTurnStarted((CHARACTERGUID)_Mime)
AND
HasActiveStatus(_Mime, "LLMIME_MIMICKING", 1)
THEN
RemoveStatus(_Mime, "LLMIME_MIMICKING");
CharacterStatusText(_Mime, "<font color='#FF7F50'>Mimicking Ended</font>");

IF
ObjectTurnEnded((CHARACTERGUID)_Mime)
AND
LLMIME_QRY_CharacterIsAMime(_Mime)
THEN
ApplyStatus(_Mime, "LLMIME_MIMICKING", -1.0);

IF
ObjectLeftCombat(_Mime, _CombatID)
AND
HasActiveStatus(_Mime, "LLMIME_MIMICKING", 1)
THEN
RemoveStatus(_Mime, "LLMIME_MIMICKING");

IF
CharacterStatusRemoved(_Mime, "LLMIME_MIMICKING", _)
AND
DB_LLMIME_Mimicking_MimicNextAction(_Mime)
THEN
NOT DB_LLMIME_Mimicking_MimicNextAction(_Mime);

IF
CharacterStatusApplied(_Mime, "LLMIME_MIMICKING", _)
AND
NOT DB_LLMIME_Mimicking_MimicNextAction(_Mime)
AND
NOT DB_LeaderLib_Combat_ActiveObject(_, (GUIDSTRING)_Mime)
THEN
DB_LLMIME_Mimicking_MimicNextAction((CHARACTERGUID)_Mime);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LaughingLeader_Mimicry"
