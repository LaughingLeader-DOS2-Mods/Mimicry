Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION

/*
Some of the mimicking events can be quite broad, so this script is used to disable them when nobody is mimicking.
*/

//REGION SCRIPT_TOGGLING
PROC
LLMIME_Mimicking_OnMimickingEnabled((CHARACTERGUID)_Mime)
THEN
TimerCancel("LLMIME_Timers_DisableMimickingScripts");
LLMIME_ScriptToggler_ToggleScriptsOn();

PROC
LLMIME_ScriptToggler_ToggleScriptsOn()
AND
NOT DB_LLMIME_ScriptToggler_ScriptsEnabled(1)
THEN
DB_LLMIME_ScriptToggler_ScriptsEnabled(1);
SysActivateGoal("LLMIME_01_Mimicking_02_Main");
SysActivateGoal("LLMIME_01_Mimicking_03_Skills");
SysActivateGoal("LLMIME_01_Mimicking_04_Attacking");
SysActivateGoal("LLMIME_01_Mimicking_05_Items");
LeaderLog_Log("SYSTEM", "[Mimicry:ScriptToggler:ToggleScriptsOn] Enabled mimicking scripts.");

//Delay disabling scripts so they have time to clear data after this event
IF
StoryEvent((CHARACTERGUID)_Mime, "Mimicry_ClearMimeBonuses")
AND
DB_LLMIME_ScriptToggler_ScriptsEnabled(1)
AND
NOT DB_LLMIME_Mimicking_MimicNextAction(_)
THEN
DB_LLMIME_ScriptToggler_Temp_BlockScriptDisable(1);
TimerCancel("LLMIME_Timers_ResetScriptToggleBlocker");
TimerLaunch("LLMIME_Timers_ResetScriptToggleBlocker", 500);

IF
TimerFinished("LLMIME_Timers_ResetScriptToggleBlocker")
AND
DB_LLMIME_ScriptToggler_ScriptsEnabled(1)
AND
NOT DB_LLMIME_Mimicking_MimicNextAction(_)
THEN
LLMIME_ScriptToggler_ToggleScriptsOff();

QRY
LLMIME_ScriptToggler_QRY_CharacterNotMimicking((CHARACTERGUID)_Character)
AND
NOT LLMIME_QRY_CharacterIsAMime(_Character)
THEN
DB_NOOP(1);

QRY
LLMIME_ScriptToggler_QRY_CharacterNotMimicking((CHARACTERGUID)_Character)
AND
CharacterIsInCombat(_Character, 0)
THEN
DB_NOOP(1);

QRY
LLMIME_ScriptToggler_QRY_CharacterNotMimicking((CHARACTERGUID)_Character)
AND
CharacterIsDead(_Character, 1)
THEN
DB_NOOP(1);

PROC
LLMIME_Mimicking_OnMimickingDisabled((CHARACTERGUID)_Mime)
AND
NOT DB_LLMIME_Mimicking_MimicNextAction(_)
AND
LLMIME_ScriptToggler_QRY_CharacterNotMimicking(_Mime)
THEN
LLMIME_ScriptToggler_ToggleScriptsOff();

PROC
LLMIME_ScriptToggler_ToggleScriptsOff()
AND
NOT DB_LLMIME_ScriptToggler_Temp_BlockScriptDisable(1)
AND
DB_LLMIME_ScriptToggler_ScriptsEnabled(1)
THEN
TimerCancel("LLMIME_Timers_DisableMimickingScripts");
TimerLaunch("LLMIME_Timers_DisableMimickingScripts", 2500);
LeaderLog_Log("SYSTEM", "[Mimicry:ScriptToggler:ToggleScriptsOff] Starting script disable timer.");

IF
TimerFinished("LLMIME_Timers_DisableMimickingScripts")
AND
NOT DB_LLMIME_ScriptToggler_Temp_BlockScriptDisable(1)
AND
NOT DB_LLMIME_Mimicking_MimicNextAction(_)
THEN
NOT DB_LLMIME_ScriptToggler_ScriptsEnabled(1);
LLMIME_Mimicking_OnScriptsCompleting();
SysCompleteGoal("LLMIME_01_Mimicking_02_Main");
SysCompleteGoal("LLMIME_01_Mimicking_03_Skills");
SysCompleteGoal("LLMIME_01_Mimicking_04_Attacking");
SysCompleteGoal("LLMIME_01_Mimicking_05_Items");
LeaderLog_Log("SYSTEM", "[Mimicry:ScriptToggler:ToggleScriptsOff] No mimes are mimicking. Disabled mimicking scripts.");

IF
TimerFinished("LLMIME_Timers_DisableMimickingScripts")
AND
NOT DB_LLMIME_ScriptToggler_Temp_BlockScriptDisable(1)
AND
LLMIME_Mimicking_QRY_MimesAvailable()
THEN
LeaderLog_Log("SYSTEM", "[Mimicry:ScriptToggler:ToggleScriptsOff] Skipped disabling scripts - Mimes are mimicking again.");
//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LaughingLeader_Mimicry"